request = require 'request'
S       = require 'string'
EventEmitter = require('events').EventEmitter

class TaringaWrapper extends EventEmitter

  constructor: (options) ->
    if options.user? and options.password? and options.logger?
      @username      = options.user
      @password      = options.password
      @user_id       = ''
      @user_key      = ''
      @logger        = options.logger
      @request       = request.defaults(
        headers: 'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; rv:31.0) Gecko/20100101 Firefox/31.0'
        jar: request.jar())
      @register 'shout'
      @register 'user'
      @register 'kn3'
      @register 'message'
      @login()
    else
      throw new Error("Not enough parameters provided. I need a username, a password")

  log: (msg) ->
    @logger.info msg

  login: ->
    self = @
    fields = form:
      nick: @username
      pass: @password
      redirect: '/'
      connect: ''
    @request.post 'http://www.taringa.net/registro/login-submit.php', fields, (error, response, body) ->
      if !error and response.statusCode is 200
        data = JSON.parse(body)
        if data.status is 0
          self.log S(data.data).decodeHTMLEntities().stripTags().s
          throw new Error("Login failed: Request was not succesful")
        else
          self.store_user_data()
      else
        throw new Error("Login failed: Request was not succesful")

  register: (libName) ->
    lib = require('./lib/' + libName)
    @[libName] = new lib(this)

  store_user_data: ->
    self = @
    @request 'http://www.taringa.net/', (error, response, body) ->
      if !error and response.statusCode is 200
        pattern = /var global_data = { user: \'(.*)\', user_key: \'(.*)\', postid/
        match   = pattern.exec(body)
        if match? and match.length is 3 and match[1] isnt '' and match[2] isnt ''
          self.user_id  = match[1]
          self.user_key = match[2]
          self.emit 'logged'
        else
          throw new Error("Login failed: Request was not succesful- UserKey")
      else
        throw new Error("Login failed: Request was not succesful")

module.exports = TaringaWrapper